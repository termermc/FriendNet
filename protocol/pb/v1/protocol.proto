syntax = "proto3";

option go_package = "friendnet.org/protocol";

package pb.v1;

// Types of protocol messages
enum MsgType {
    // Do not use.
    MSG_TYPE_UNSPECIFIED = 0;

    // [C2S, S2C, C2C] A ping message.
    // May be sent by either the client or server, but the other must respond with MSG_TYPE_PONG.
    // Must be responded to with MSG_TYPE_PONG, or the connection will be terminated.
    // Either side may have its own arbitrary timeout which may cause disconnection if not met.
    // Expected: Message MSG_TYPE_PONG.
    MSG_TYPE_PING = 1;

    // [C2S, S2C, C2C] Response to MSG_TYPE_PING.
    MSG_TYPE_PONG = 2;

    // [C2S, S2C, C2C] Acknowledgement of success.
    // Sent as a reply to other messages.
    MSG_TYPE_ACKNOWLEDGED = 3;

    // [C2S, S2C, C2C] An error message.
    // Sent as a reply to other messages.
    MSG_TYPE_ERROR = 4;

    // [C2S] Initial client version negotiation.
    MSG_TYPE_VERSION = 5;

    // [S2C] Indicates that the server accepted the client's protocol version.
    MSG_TYPE_VERSION_ACCEPTED = 6;

    // [S2C] Indicates that the server rejected the client's protocol version.
    MSG_TYPE_VERSION_REJECTED = 7;

    // [C2S] Initial client authentication with the server.
    MSG_TYPE_AUTHENTICATE = 8;

    // [S2C] Indicates that client authentication was accepted.
    MSG_TYPE_AUTH_ACCEPTED = 9;

    // [S2C] Indicates that client authentication was denied.
    MSG_TYPE_AUTH_REJECTED = 10;

    // [C2S] Request to open an outbound proxy to a connected peer.
    // The server will cancel the stream with an error if the target peer could not be contacted.
    // If successful, the stream will be converted to a proxied stream to the target peer.
    MSG_TYPE_OPEN_OUTBOUND_PROXY = 11;

    // [S2C] Notification of a new inbound proxy stream from another peer.
    // The client can choose to cancel the stream or send data on it.
    // All data after the notification message comes from the origin peer.
    MSG_TYPE_INBOUND_PROXY = 12;

    // [C2C] Request to get files inside a user's directory.
    // Expected: Either:
    //  - Repeated message MSG_TYPE_DIR_FILES until stream is closed by receiver.
    //  - Message MSG_TYPE_ERROR of ERR_TYPE_FILE_NOT_EXIST.
    MSG_TYPE_GET_DIR_FILES = 13;

    // [C2C] A possibly non-exhaustive list of files in a directory.
    MSG_TYPE_DIR_FILES = 14;

    // [C2C] Request to get metadata about a file without reading it.
    // Expected: Either:
    //  - Message MSG_TYPE_FILE_META.
    //  - Message MSG_TYPE_ERROR of ERR_TYPE_FILE_NOT_EXIST.
    MSG_TYPE_GET_FILE_META = 15;

    // [C2C] Metadata about a file, including its size.
    MSG_TYPE_FILE_META = 16;

    // [C2C] Request to get a file's metadata and contents.
    // Expected: Either:
    //  - Message MSG_TYPE_FILE_META then the file's requested binary content until the stream is closed by receiver.
    //    If the file is a directory, the size will be zero and no content will be sent.
    //  - Message MSG_TYPE_ERROR of ERR_TYPE_FILE_NOT_EXIST.
    MSG_TYPE_GET_FILE = 17;

    // [C2S] Request to get a list of online users in the room.
    // Expected: Repeated message MSG_TYPE_ONLINE_USERS until stream is closed by receiver.
    MSG_TYPE_GET_ONLINE_USERS = 18;

    // [S2C] List of online users in the room.
    MSG_TYPE_ONLINE_USERS = 19;

    // [C2S] Notification to let the server know the client is disconnecting.
    // The client must not communicate with the server after sending this message.
    // Expected: Message MSG_TYPE_ACKNOWLEDGED.
    MSG_TYPE_BYE = 20;
}

// Ping message.
message MsgPing {
    // The epoch millisecond timestamp when the message was sent.
    // Used to measure latency.
    int64 sent_ts = 1;
}

// Pong message.
message MsgPong {
    // The epoch millisecond timestamp when the message was sent.
    // Used to measure latency.
    int64 sent_ts = 1;
}

// Acknowledgement message.
// Empty.
message MsgAcknowledged {
}

// Types of errors that can be returned in protocol error messages.
enum ErrType {
    // Do not use.
    ERR_TYPE_UNSPECIFIED = 0;

    // An internal error occurred.
    ERR_TYPE_INTERNAL = 1;

    // An invalid message was received.
    ERR_TYPE_MALFORMED_MESSAGE = 2;

    // The message's payload exceeded the size limit.
    ERR_TYPE_PAYLOAD_TOO_LARGE = 3;

    // A required field was missing.
    ERR_TYPE_MISSING_FIELDS = 4;

    // An invalid field was received.
    ERR_TYPE_INVALID_FIELDS = 5;

    // A message was received, but its type was unexpected.
    ERR_TYPE_UNEXPECTED_MSG_TYPE = 6;

    // Requests were sent too quickly and the request was rate limited.
    ERR_TYPE_RATE_LIMITED = 7;

    // The file did not exist.
    ERR_TYPE_FILE_NOT_EXIST = 8;

    // Unimplemented functionality.
    ERR_TYPE_UNIMPLEMENTED = 9;

    // Permission denied.
    ERR_TYPE_PERMISSION_DENIED = 10;

    // A path did not point to a directory.
    ERR_TYPE_PATH_NOT_DIRECTORY = 11;
}

// An error, usually sent by the server.
message MsgError {
    // The error type.
    ErrType type = 1;

    // The error message (optional).
    optional string message = 2;
}

// A protocol version.
message ProtoVersion {
    // The minor protocol version.
    // Major protocol versions can be considered complete overhauls or changes to the underlying message header format.
    uint32 major = 1;

    // The minor protocol version.
    // Minor protocol versions include breaking changes, but many parts of the protocol will remain the same between versions.
    uint32 minor = 2;

    // The patch protocol version.
    // Patch protocol versions may include some trivial small additions, but nothing breaking.
    uint32 patch = 3;
}

// Client protocol negotiation.
message MsgVersion {
    // The client's protocol version.
    ProtoVersion version = 1;
}

// Message sent by the server as a reply to PROTO_VERSION.
// If a client receives this message, it may continue the handshake process.
message MsgVersionAccepted {
    // The server's protocol version.
    ProtoVersion version = 1;
}

// Reasons for a client's version being rejected
enum VersionRejectionReason {
    // No reason specified.
    // More details may be in the rejection message.
    VERSION_REJECTION_REASON_UNSPECIFIED = 0;

    // The client's version is too old.
    VERSION_REJECTION_REASON_TOO_OLD = 2;

    // The client's version is too new.
    VERSION_REJECTION_REASON_TOO_NEW = 3;
}

// Message sent by the server as a reply to PROTO_VERSION.
// If a client receives this message, it will be disconnected and must connect with a suitable version.
message MsgVersionRejected {
    // The server's protocol version.
    ProtoVersion version = 1;

    // The reason the client's version was rejected.
    VersionRejectionReason reason = 2;

    // A message accompanying the rejection (optional).
    optional string message = 3;
}

// Client authentication.
// Should be the first message sent to the server immediately upon connection.
// It will be replied to with either PROTO_AUTH_ACCEPTED or PROTO_AUTH_REJECTED.
message MsgAuthenticate {
    // The room the user is trying to authenticate with.
    string room = 1;

    // The user's username.
    string username = 2;

    // The user's password.
    string password = 3;
}

// Message sent by the server as a reply to PROTO_AUTHENTICATE.
// If a client receives this message, it is considered to be authenticated and connected, and a session has been established.
message MsgAuthAccepted {
}

// Reasons for a client's authentication request being rejected.
enum AuthRejectionReason {
    // No reason specified.
    // More details may be in the rejection message.
    AUTH_REJECTION_REASON_UNSPECIFIED = 0;

    // The client provided invalid credentials (e.g. invalid token).
    AUTH_REJECTION_REASON_INVALID_CREDENTIALS = 2;

    // The user is banned and therefore not allowed to connect.
    AUTH_REJECTION_REASON_BANNED = 3;

    // A client with the same username is already connected.
    AUTH_REJECTION_REASON_ALREADY_CONNECTED = 4;
}

// Message sent by the server as a reply to PROTO_AUTHENTICATE.
// The client will be disconnected after receiving this message.
message MsgAuthRejected {
    // The reason the client's authentication request was rejected.
    AuthRejectionReason reason = 1;

    // A message accompanying the rejection (optional).
    optional string message = 2;
}

// See MSG_TYPE_OPEN_OUTBOUND_PROXY.
message MsgOpenOutboundProxy {
    // The target peer's username.
    string target_username = 1;
}

// See MSG_TYPE_INBOUND_PROXY.
message MsgInboundProxy {
    // The origin peer's username.
    string origin_username = 1;
}

// See MSG_TYPE_GET_DIR_FILES.
message MsgGetDirFiles {
    // The path of the directory within the share.
    // The path must begin with a `/`.
    string path = 1;
}

// See MSG_TYPE_DIR_FILES.
message MsgDirFiles {
    // A non-exhaustive list of files within a directory.
    repeated MsgFileMeta files = 1;
}

// See MSG_TYPE_GET_FILE_META.
message MsgGetFileMeta {
    // The path to the file.
    string path = 1;
}

// See MSG_TYPE_FILE_META.
message MsgFileMeta {
    // The file's name.
    string name = 1;

    // Whether the file is a directory.
    bool is_dir = 2;

    // The file's size, in bytes.
    // Always zero if the file is a folder.
    uint64 size = 3;
}

// See MSG_TYPE_GET_FILE.
message MsgGetFile {
    // The path to the file.
    string path = 1;

    // The offset into the file to read, in bytes.
    // Values above the file size will just result in no data being returned.
    uint64 offset = 2;

    // The limit of the file to read, in bytes.
    // Specify 0 for no limit.
    uint64 limit = 3;
}

// See MSG_TYPE_GET_ONLINE_USERS.
message MsgGetOnlineUsers {
}

// OnlineUserInfo is information about an online user.
message OnlineUserInfo {
    // The user's username.
    string username = 1;
}

// See MSG_TYPE_ONLINE_USERS.
message MsgOnlineUsers {
    // A list of online users in the room and their statuses.
    repeated OnlineUserInfo users = 1;
}

// See MSG_TYPE_BYE.
message MsgBye {
}
